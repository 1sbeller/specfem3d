\chapter{Running the Solver \texttt{xspecfem3D}}\label{cha:Running-the-Solver}

Now that you have successfully generated the databases, you are ready
to compile the solver. In the main directory, type
{\small
\begin{verbatim}
make xspecfem3D
\end{verbatim}
}
\noindent
Please note that \texttt{xspecfem3D} must be called directly from
the main directory, as most of the binaries of the package.\\

\noindent
The solver needs three input files in the \texttt{DATA} directory
to run:
\begin{description}
\item [{\texttt{Par\_file}}] the main parameter file which was discussed
in detail in the previous Chapter~\ref{cha:Creating-Distributed-Databases},
\item [{\texttt{CMTSOLUTION}} or {\texttt{FORCESOLUTION}}] the earthquake
source parameter file or the force source parameter file, and
\item [{\texttt{STATIONS}}] the stations file.
\end{description}
Most parameters in the \texttt{Par\_file} should be set prior to running
the databases generation. Only the following parameters may be changed
after running \texttt{xgenerate\_databases}:
\begin{itemize}
\item the simulation type control parameters: \texttt{SIMULATION\_TYPE}
and \texttt{SAVE\_FORWARD}
\item the time step parameters \texttt{NSTEP} and \texttt{DT}
\item the absorbing boundary control parameter \texttt{PML\_CONDITIONS}
on condition that the\\
 \texttt{PML\_INSTEAD\_OF\_FREE\_SURFACE} flag remains unmodified
after running the databases generation.
\item the movie control parameters \texttt{MOVIE\_SURFACE}, \texttt{MOVIE\_VOLUME},
and \texttt{NTSTEPS\_BETWEEN\_FRAMES}
\item the ShakeMap\textregistered{} option \texttt{CREATE\_SHAKEMAP}
\item the output information parameters \texttt{MOVIE\_TYPE}, \texttt{NTSTEP\_BETWEEN\_OUTPUT\_INFO} and\\
\texttt{NTSTEP\_BETWEEN\_OUTPUT\_SEISMOS}
\item the \texttt{PRINT\_SOURCE\_TIME\_FUNCTION} flags
\end{itemize}
Any other change to the \texttt{Par\_file} implies rerunning both
the database generator \texttt{xgenerate\_databases} and the solver
\texttt{xspecfem3D}.


For any particular earthquake, the \texttt{CMTSOLUTION} file that
represents the point source may be obtained directly from the Harvard
Centroid-Moment Tensor (CMT) web page \urlwithparentheses{www.seismology.harvard.edu}.
It looks like the example shown in Fig. \ref{fig:CMTSOLUTION-file}.
\begin{figure}[htp]
\begin{centering}
\includegraphics[width=0.8\textwidth]{figures/Hollywood_CMT.jpg}
\par
\end{centering}
\caption{\texttt{CMTSOLUTION} file based on the
format from the Harvard CMT catalog. \textbf{M} is the moment tensor,
$M_{0}${\small {} }is the seismic moment, and $M_{w}$ is the moment
magnitude.}
\label{fig:CMTSOLUTION-file}
\end{figure}
%
The \texttt{CMTSOLUTION} file should be edited in the following way:
\begin{itemize}
\item Set the latitude or UTM $x$ coordinate, longitude or UTM $y$ coordinate, depth of the source (in km).
\item Set the \texttt{time shift} parameter equal to $0.0$ (the solver
will not run otherwise.) The time shift parameter would simply apply
an overall time shift to the synthetics, something that can be done
in the post-processing (see Section \ref{sec:Process-data-and-syn}).
\item For point-source simulations (see finite sources, page \pageref{To-simulate-a})
we recommend setting the source half-duration parameter \texttt{half
duration} equal to zero, which corresponds to simulating a step source-time
function, i.e., a moment-rate function that is a delta function. If
\texttt{half duration} is not set to zero, the code will use a Gaussian
(i.e., a signal with a shape similar to a `smoothed triangle', as
explained in \citet{KoTr02a} and shown in Fig~\ref{fig:gauss.vs.triangle})
source-time function with half-width \texttt{half duration}. We prefer
to run the solver with \texttt{half duration} set to zero and convolve
the resulting synthetic seismograms in post-processing after the run,
because this way it is easy to use a variety of source-time functions
(see Section \ref{sec:Process-data-and-syn}). \citet{KoTr02a} determined
that the noise generated in the simulation by using a step source
time function may be safely filtered out afterward based upon a convolution
with the desired source time function and/or low-pass filtering. Use
the serial code \texttt{convolve\_source\_timefunction.f90} and the
script \texttt{convolve\_source\_timefunction.csh} for this purpose,
or alternatively use signal-processing software packages such as SAC
\urlwithparentheses{www.llnl.gov/sac}. Type
{\small
\begin{verbatim}
make xconvolve_source_timefunction
\end{verbatim}
}
to compile the code and then set the parameter \texttt{hdur} in \texttt{convolve\_source\_timefunction.csh}
to the desired half-duration.

\item The zero time of the simulation corresponds to the center of the triangle/Gaussian,
or the centroid time of the earthquake. The start time of the simulation
is $t=-1.5*\texttt{half duration}$ (the 1.5 is to make sure the moment
rate function is very close to zero when starting the simulation).
To convert to absolute time $t_{\mathrm{abs}}$, set
%
\begin{lyxcode}
$t_{\mathrm{abs}}=t_{\mathrm{pde}}+\texttt{time shift}+t_{\mathrm{synthetic}}$
\end{lyxcode}

where $t_{\mathrm{pde}}$ is the time given in the first line of the
\texttt{CMTSOLUTION}, \texttt{time shift} is the corresponding value
from the original \texttt{CMTSOLUTION} file and $t_{\mathrm{synthetic}}$
is the time in the first column of the output seismogram.
\end{itemize}
%
\begin{figure}[htp]
\begin{centering}
\includegraphics[width=3.5in]{figures/gauss_vs_triangle_mod.jpg}
\par
\end{centering}
\caption{Comparison of the shape of a triangle and the Gaussian function actually used.}
\label{fig:gauss.vs.triangle}
\end{figure}


If you know the earthquake source in strike/dip/rake format rather
than in \texttt{CMTSOLUTION} format, use the C code \texttt{SPECFEM3D\_GLOBE/utils/strike\_dip\_rake\_to\_CMTSOLUTION.c}
to convert it. The conversion formulas are given for instance in \citet{AkRi80}.
Note that the \citet{AkRi80} convention is slightly different from
the Harvard \texttt{CMTSOLUTION} convention (the sign of some components
is different). The C code outputs both.

Centroid latitude and longitude should be provided in geographical
coordinates. The code converts these coordinates to geocentric coordinates~\citep{DaTr98}.
Of course you may provide your own source representations by designing
your own \texttt{CMTSOLUTION} file. Just make sure that the resulting
file adheres to the Harvard CMT conventions (see Appendix~\ref{cha:Coordinates}).
Note that the first line in the \texttt{CMTSOLUTION} file is the Preliminary
Determination of Earthquakes (PDE) solution performed by the USGS
NEIC, which is used as a seed for the Harvard CMT inversion. The PDE
solution is based upon P waves and often gives the hypocenter of the
earthquake, i.e., the rupture initiation point, whereas the CMT solution
gives the `centroid location', which is the location with dominant
moment release. The PDE solution is not used by our software package
but must be present anyway in the first line of the file.

\label{To-simulate-a}To simulate a kinematic rupture, i.e., a finite-source
event, represented in terms of $N_{\mathrm{sources}}$ point sources,
provide a \texttt{CMTSOLUTION} file that has $N_{\mathrm{sources}}$
entries, one for each subevent (i.e., concatenate $N_{\mathrm{sources}}$
\texttt{CMTSOLUTION} files to a single \texttt{CMTSOLUTION} file).
At least one entry (not necessarily the first) must have a zero \texttt{time
shift}, and all the other entries must have non-negative \texttt{time
shift}. Each subevent can have its own half duration, latitude, longitude,
depth, and moment tensor (effectively, the local moment-density tensor).

Note that the zero in the synthetics does NOT represent the hypocentral
time or centroid time in general, but the timing of the \textit{center}
of the source triangle with zero \texttt{time shift} (Fig~\ref{fig:source_timing}).

Although it is convenient to think of each source as a triangle, in
the simulation they are actually Gaussians (as they have better frequency
characteristics). The relationship between the triangle and the gaussian
used is shown in Fig~\ref{fig:gauss.vs.triangle}. For finite fault
simulations it is usually not advisable to use a zero half duration
and convolve afterwards, since the half duration is generally fixed
by the finite fault model.

\vspace{1cm}


\noindent The \texttt{FORCESOLUTION} file should be edited in the
following way:
\begin{itemize}
\item Set the \texttt{time shift} parameter equal to $0.0$ (the solver
will not run otherwise.) The time shift parameter would simply apply
an overall time shift to the synthetics, something that can be done
in the post-processing (see Section \ref{sec:Process-data-and-syn}).
\item Set the \texttt{f0} parameter (the dominant frequency) of the Ricker source time
function when {\texttt{USE\_RICKER\_TIME\_FUNCTION}} is turned on
in the main parameter file {\texttt{Par\_file}}. In case that the
solver uses a (pseudo) Dirac delta source time function to represent
a force point source, a very short duration of five time steps is automatically set by default.
\item Set the latitude or UTM $x$ coordinate, longitude or UTM $y$ coordinate, depth of the source (in km).
\item Set the magnitude of the force source.
\item Set the components of a (non-unitary) direction vector for the force
source in the East/North/Vertical basis (see Appendix A for the orientation
of the reference frame).
\end{itemize}
\noindent Where necessary, set a \texttt{FORCESOLUTION} file in the
same way you configure a \texttt{CMTSOLUTION} file with $N_{\mathrm{sources}}$
entries, one for each subevent (i.e., concatenate $N_{\mathrm{sources}}$
\texttt{FORCESOLUTION} files to a single \texttt{FORCESOLUTION} file).
At least one entry (not necessarily the first) must have a zero \texttt{time
shift}, and all the other entries must have non-negative \texttt{time
shift}. Each subevent can have its own half latitude, longitude, depth,
\texttt{half duration} and force parameters.

\begin{figure}[H]
\begin{centering}
\includegraphics[width=4in]{figures/source_timing.jpg}
\par
\end{centering}
\caption{Example of timing for three sources. The center of the first source
triangle is defined to be time zero. Note that this is NOT in general
the hypocentral time, or the start time of the source (marked as tstart).
The parameter \texttt{time shift} in the \texttt{CMTSOLUTION} file
would be t1(=0), t2, t3 in this case, and the parameter \texttt{half
duration} would be hdur1, hdur2, hdur3 for the sources 1, 2, 3 respectively.}
{\small \label{fig:source_timing} }
\end{figure}


The solver can calculate seismograms at any number of stations for
basically the same numerical cost, so the user is encouraged to include
as many stations as conceivably useful in the \texttt{STATIONS} file,
which looks like this:
%
\begin{figure}[H]
\begin{centering}
\includegraphics[width=4in]{figures/STATIONS_basin_explained.jpg}
\par
\end{centering}
\caption{Sample \texttt{STATIONS} file. Station latitude and longitude should
be provided in geographical coordinates. The width of the station
label should be no more than 32 characters (see \texttt{MAX\_LENGTH\_STATION\_NAME}
in the \texttt{constants.h} file), and the network label should be
no more than 8 characters (see \texttt{MAX\_LENGTH\_NETWORK\_NAME}
in the \texttt{constants.h} file).}
\label{fig:Sample-STATIONS-file.}
\end{figure}



Each line represents one station in the following format:
{\small
\begin{verbatim}
Station Network Latitude(degrees) Longitude(degrees) Elevation(m) burial(m)
\end{verbatim}
}
The solver \texttt{xspecfem3D} filters the list of stations in file
\texttt{DATA/STATIONS} to exclude stations that are not located within
the region given in the \texttt{Par\_file} (between \texttt{LATITUDE\_MIN}
and \texttt{LATITUDE\_MAX} and between \texttt{LONGITUDE\_MIN} and
\texttt{LONGITUDE\_MAX}). The filtered file is called \texttt{DATA/STATIONS\_FILTERED}.

Solver output is provided in the \texttt{OUTPUT\_FILES} directory
in the \texttt{output\_solver.txt} file. Output can be directed to
the screen instead by uncommenting a line in \texttt{constants.h}:
\begin{verbatim}
! uncomment this to write messages to the screen
! integer, parameter :: IMAIN = ISTANDARD_OUTPUT
\end{verbatim}
On PC clusters the seismogram files are generally written to the local
disks (the path \texttt{LOCAL\_PATH} in the \texttt{Par\_file}) and
need to be gathered at the end of the simulation.

While the solver is running, its progress may be tracked by monitoring
the `\texttt{\small timestamp{*}}' files in the \texttt{\small OUTPUT\_FILES/} directory. These tiny
files look something like this:
{\small
\begin{verbatim}
Time step #          10000
Time:     108.4890      seconds
Elapsed time in seconds =    1153.28696703911
Elapsed time in hh:mm:ss =     0 h 19 m 13 s
Mean elapsed time per time step in seconds =     0.115328696703911
Max norm displacement vector U in all slices (m) =     1.0789589E-02
\end{verbatim}
}
The \texttt{\small timestamp{*}} files provide the
\texttt{\small Mean elapsed time per time step in seconds}, which may be used
to assess performance on various machines (assuming you are the only
user on a node), as well as the
\texttt{\small Max norm displacement vector U in all slices~(m)}.
If something is wrong with the
model, the mesh, or the source, you will see the code become unstable
through exponentially growing values of the displacement and fluid
potential with time, and ultimately the run will be terminated by
the program. You can control the rate at which the timestamp files
are written based upon the parameter
\texttt{\small NTSTEP\_BETWEEN\_OUTPUT\_INFO}
in the \texttt{\small Par\_file}.

Having set the \texttt{Par\_file} parameters, and having provided
the \texttt{CMTSOLUTION} (or the \texttt{FORCESOLUTION}) and \texttt{STATIONS}
files, you are now ready to launch the solver! This is most easily
accomplished based upon the \texttt{go\_solver} script (See Chapter
\ref{cha:Scheduler} for information about running through a scheduler,
e.g., LSF). You may need to edit the last command at the end of the
script that invokes the \texttt{mpirun} command. The \texttt{runall}
script compiles and runs both \texttt{xgenerate\_databases} and \texttt{xspecfem3D}
in sequence. This is a safe approach that ensures using the correct
combination of distributed database output and solver input.

It is important to realize that the CPU and memory requirements of
the solver are closely tied to choices about attenuation (\texttt{ATTENUATION})
and the nature of the model (i.e., isotropic models are cheaper than
anisotropic models). We encourage you to run a variety of simulations
with various flags turned on or off to develop a sense for what is
involved.

For the same model, one can rerun the solver for different events
by simply changing the \texttt{CMTSOLUTION} or \texttt{FORCESOLUTION}
file, or for different stations by changing the \texttt{STATIONS}
file. There is no need to rerun the \texttt{xgenerate\_databases}
executable. Of course it is best to include as many stations as possible,
since this does not add to the cost of the simulation.

We have also added the ability to run several calculations (several earthquakes)
in an embarrassingly-parallel fashion from within the same run;
this can be useful when using a very large supercomputer to compute
many earthquakes in a catalog, in which case it can be better from
a batch job submission point of view to start fewer and much larger jobs,
each of them computing several earthquakes in parallel.
To turn that option on, set parameter \texttt{NUMBER\_OF\_SIMULTANEOUS\_RUNS}
to a value greater than 1 in file setup/constants.h.in before
configuring and compiling the code.
When that option is on, of course the number of processor cores used to start
the code in the batch system must be a multiple of \texttt{NUMBER\_OF\_SIMULTANEOUS\_RUNS},
all the individual runs must use the same number of processor cores,
which as usual is \texttt{NPROC} in the input file \texttt{DATA/Par\_file},
and thus the total number of processor cores to request from the batch system
should be \texttt{NUMBER\_OF\_SIMULTANEOUS\_RUNS $\times$ NPROC}.
All the runs to perform must be placed in directories called \texttt{run0001}, \texttt{run0002}, \texttt{run0003} and so on (with exactly four digits)
and you must create a link from the root directory of the code
to the first copy of the executable programs by typing \texttt{ln -s run0001/bin bin}.

%------------------------------------------------------------------------------------------------%

%------------------------------------------------------------------------------------------------%

\chapter{Note on the SPECFEM acoustic formulation}

{\Large Note from Quentin Brissaud, Dimitri Komatitsch and Rapha\"el Garcia, October 2015,with feedback from Jeroen Tromp and from Emmanuel Chaljub}

\section{About the potential formulation used in SPECFEM for purely acoustic waves (i.e. in the absence of gravity terms)}

In SPECFEM, when considering purely acoustic waves (neglecting gravity acceleration and viscosity)
in fluid regions one uses a potential formulation to represent the "density times displacement" perturbation
\citep{ChKoViCaVaFe07}:
\begin{equation}
\rho \mathbf{u} = \nabla \chi
\label{potential}
\end{equation}
where $\mathbf{u}$ is the displacement perturbation, $\rho$ the background density and $\chi$ is the scalar potential.\\
This formulation has several great advantages: it reduces the number of unknowns from three to one, and it also automatically removes artefacts
in finite-element methods (FEM) caused by the displacement formulation \citep{HaOuVe78}.
This is crucial since it is the main reason for which a displacement formulation cannot be used in fluid regions in a FEM.
It also permits acoustic-elastic coupling based on a non-iterative time scheme \citep{ChVa04}.
Displacement is then: u = grad(Chi) / rho,
velocity is then: v = grad(Chi\_dot) / rho (Chi\_dot being the time derivative of Chi)
and pressure is: p = - Chi\_dot\_dot  (Chi\_dot\_dot being the time second derivative of Chi).
First-order acoustic-acoustic discontinuities are also handled automatically
because pressure is continuous at such an interface, therefore Chi\_dot\_dot
is continuous, therefore Chi is also continuous, which is consistent with
the spectral-element basis functions and with the assembling process.
This is the reason why a simple displacement potential u = grad(Chi) would
not work because it would be discontinuous at such an interface and would
therefore not be consistent with the basis functions. And first-order acoustic-acoustic discontinuities are used
routinely in several domains, e.g. in the oil industry when dealing with geological models as acoustic only (no S waves),
or in ocean acoustics when considering the ocean bottom as fluid (again, no S waves).
\newline

However, this formulation indirectly assumes that the density is spatially constant, or locally slowly varying (e.g. inside a given spectral element),
because acoustic displacements must be irrotational. Since we know that $\nabla \times \mathbf{u}$ must be equal to zero
we can see that when density has strong local variations, equation (\ref{potential}) is not valid any more.
Indeed, taking the rotational of \eqref{potential}
\begin{eqnarray*}
\nabla \times (\rho \mathbf{u}) &=& \nabla\times\nabla \chi \, ,
\end{eqnarray*}
since the curl of a gradient is always zero i.e. for any scalar $\chi$, $ \nabla\times\nabla \chi = 0$, we get
\begin{eqnarray*}
\nabla\rho\times\mathbf{u} + \rho\nabla\times\mathbf{u} &=& \mathbf{0}\\
\nabla\times\mathbf{u}&=&-(1/\rho)\nabla\rho\times\mathbf{u}
\end{eqnarray*}
Then, one notices that in the case of strong density gradients the rotational of $\mathbf{u}$ is no longer zero.
Thus, the potential formulation \eqref{potential} is no more valid. It is valid only when $(1/\rho)\nabla\rho\times\mathbf{u}$ can be considered negligible,
i.e. when both the gradient of density and the value of displacement are small, or if the displacement is parallel or quasi-parallel to the gradient of density,
in which case their rotational is also close to zero.
\newline

Another approach exists for acoustic waves, based on a displacement potential instead of on a potential of $\rho \mathbf{u}$:
\begin{equation}
\mathbf{u} = \nabla \chi \, ,
\end{equation}
which correctly gives $\nabla\times\mathbf{u} = \mathbf{0}$.
But in this case the gradient of density is neglected in the Eulerian momentum equation in order to identify gradient terms.
Indeed, from the Eulerian momentum equation for inviscid acoustic waves only
\begin{eqnarray*}
\rho\partial_t^2\mathbf{u} &=& -\nabla p\\
\nabla (\partial_t^2\chi)&=& -(1/\rho)\nabla p \, .
\end{eqnarray*}
When $\nabla\rho \gg \mathbf{0}$ strictly speaking one cannot identify $\partial_t^2\chi$ with $p$.
\newline

A solution to this could be to work with pressure as the scalar unknown (\cite{God11}, equation 23),
or even better with the time integral (the primitive) of pressure (see e.g. \cite{Eve81});
this was the approach that was originally implemented in SPECFEM until 10 years ago or so, but \cite{ChVa04} showed that switching to a displacement potential
or to a potential of $\rho \mathbf{u}$ enables one to couple the fluid and solid regions without iterating on the coupling condition in the time scheme,
thus resulting in much easier and cheaper implementation; since at that time SPECFEM users were not studying media with strong local variations of density (in solid Earth
geophysics such large local variations in fluid regions never happen), the SPECFEM developers permanently switched to such a displacement-based potential formulation.
However, for media with strong local variations of density in a fluid region we should reconsider the issue and consider trying the pressure-based formulation again
to see if there is a way of using it without having to numerically iterate on the fluid-solid matching condition.
\newline

Another possibility, suggested by Emmanuel Chaljub, would be to use two potentials instead of a single one (see Section~2.4 of \cite{ChKoViCaVaFe07}).
\newline

Cases in which this can be problematic may include e.g. upper atmosphere studies: the density there is very small but displacements can become very large;
in 1D atmosphere models $\frac{\nabla \rho}{\rho}$ is approximately constant and equal to -1/H, where H is the scaling height,
which leads to $\frac{\nabla \rho}{\rho} \simeq$ 3.42*1e-5, i.e. very small; however displacements there can be large
and thus it is not clear if $(1/\rho)\nabla\rho\times\mathbf{u}$ can be considered negligible there.
\newline

Note that it is only when gravity is off that there is potentially a problem.
More details on the case with gravity can be found in \cite{ChVa04} (in particular in their Figure 2 and Section 2.1)
and in \cite{KoTsTr05}. As summarized by Jeroen Tromp, note that in the presence of gravity and rotation we do not assume that density is constant in the fluid
(see Section~3.3 in \cite{KoTsTr05}). Instead, we assume that the fluid is stably stratified, i.e., that the Brunt-V\"ais\"al\"a frequency vanishes.
Only in the step leading to eqns. (35) and (36) in \cite{KoTsTr05} do we make the Cowling approximation (\cite{Cow41}) and set the Brunt-V\"ais\"al\"a frequency equal to zero.
If we make the Cowling approximation, assume the core is stably stratified, and ignore rotation, then we obtain eqn. (41).
In that case the displacement is the gradient of a potential (not density times the gradient of a potential).
More generally, the displacement is given by eqn. (28). The results with and without rotation (always assuming stable stratification), are implemented in SPECFEM3D\_GLOBE.
\newline

The question for regional simulations, e.g., in an ocean layer, is whether or not we should incorporate gravity in the analysis, and whether or not we can assume that, on the time scales of seismic waves, the ocean is stably stratified.
\newline

Note that one cannot have density gradients coming out of nowhere, i.e., in principle one cannot ignore gravity. In practice, density gradients are controlled by the Brunt-V\"ais\"al\"a frequency, be it in the oceans or the outer core. If we assume stable stratification, then we are naturally led to (35) and (36) in \cite{KoTsTr05}, or (41) in the absence of rotation. Jeroen Tromp thinks we either need to assume $N^2=0$ or $N^2>0$, since when $N^2<0$ the fluid will overturn. SPECFEM3D/SPECFEM3D\_GLOBE currently implement the $N^2=0$ case, so the question is whether we need to worry about the case $N^2>0$. The latter corresponds to eqns. (33) and (34) in Komatitsch et al. (2007) (with phi=0 in the Cowling approximation).
\newline

Regarding always including the effect of gravity in order to avoid this issue,
one (important) exception could be the oil industry case when they use P waves only, in which case they do not include gravity and their spatially-varying density is just rho taken from the elastic model... These days they mostly run fully elastic simulations instead? (although some groups still often uses the acoustic approximation for large inverse problems); that's also true in ocean acoustics because the approximation often made is to consider the solid ocean bottom as fluid (no S waves, again just taking rho and cp from the elastic model).
\newline

So, as summarized by Jeroen, the question is whether we can safely assume $N^2=0$ as we currently do, or whether we also need to consider the case $N^2>0$.

